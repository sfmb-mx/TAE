#+TITLE:         Unit 7 Visualization
#+AUTHOR:        Sergio-Feliciano Mendoza-Barrera
#+DRAWERS:       sfmb
#+EMAIL:         smendoza.barrera@gmail.com
#+DATE:          22/07/2015
#+DESCRIPTION:   Visualization tools in R
#+KEYWORDS:      R, data science, emacs, ESS, org-mode, visualization
#+LANGUAGE:      en
#+OPTIONS:       H:10 num:t toc:nil \n:nil @:t ::t |:t ^:{} -:t f:t *:t <:t d:HIDDEN
#+OPTIONS:       TeX:t LaTeX:t skip:nil d:nil todo:t pri:nil tags:not-in-toc
#+OPTIONS:       LaTeX:dvipng
#+INFOJS_OPT:    view:nil toc:nil ltoc:t mouse:underline buttons:0 path:http://orgmode.org/org-info.js
#+EXPORT_SELECT_TAGS: export
#+EXPORT_EXCLUDE_TAGS: noexport
#+LINK_UP:
#+LINK_HOME:
#+XSLT:
#+STYLE: <link rel="stylesheet" type="text/css" href="dft.css"/>

#+LaTeX_CLASS: IEEEtran
#+LATEX_CLASS_OPTIONS: [letterpaper, 9pt, onecolumn, twoside, technote, final]
#+LATEX_HEADER: \usepackage{minted}
#+LATEX_HEADER: \usepackage{makeidx}

#+LATEX_HEADER: \usepackage[lining,tabular]{fbb} % so math uses tabular lining figures
#+LATEX_HEADER: \usepackage[scaled=.95,type1]{cabin} % sans serif in style of Gill Sans
#+LATEX_HEADER: \usepackage[varqu,varl]{zi4}% inconsolata typewriter
#+LATEX_HEADER: \usepackage[T1]{fontenc} % LY1 also works
#+LATEX_HEADER: \usepackage[libertine,bigdelims]{newtxmath}
#+LATEX_HEADER: \usepackage[cal=boondoxo,bb=boondox,frak=boondox]{mathalfa}
#+LATEX_HEADER: \useosf % change normal text to use proportional oldstyle figures

#+LATEX_HEADER: \markboth{Unit 7. Visualization. July 2015}%
#+LATEX_HEADER: {Sergio-Feliciano Mendoza-Barrera}

#+LATEX_HEADER: \newcommand{\degC}{$^\circ$C{}}

#+STYLE: <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"> </script>

#+ATTR_HTML: width="500px"

# -*- mode: org; -*-
#+OPTIONS:   toc:2

#+HTML_HEAD: <link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/readtheorg/css/htmlize.css"/>
#+HTML_HEAD: <link rel="stylesheet" type="text/css" href="http://www.pirilampo.org/styles/readtheorg/css/readtheorg.css"/>

#+HTML_HEAD: <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
#+HTML_HEAD: <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
#+HTML_HEAD: <script type="text/javascript" src="http://www.pirilampo.org/styles/lib/js/jquery.stickytableheaders.js"></script>
#+HTML_HEAD: <script type="text/javascript" src="http://www.pirilampo.org/styles/readtheorg/js/readtheorg.js"></script>

#+BEGIN_ABSTRACT
Unit 7, Visualization tools in R, part of the Analytics Edge course.
#+END_ABSTRACT

* Visualizing the World: An Introduction to Visualization

This week, we'll be discussing the power of visualizations for
understanding worldwide trends and for using analytics to stop
crime. In the first lecture, we'll use data from the World Health
Organization to create visualizations that help us understand and
communicate global health trends.

[[../graphs/VIS-VisualizingTheWorld.png]]

In the second lecture, we'll discuss predictive policing, and how
police departments across the country are using data and analytics to
improve decision making.

** Video 1: The Power of Visualizations

We'll discuss the idea of using visualization to better understand
data and to provide insights on the problem we're addressing.

*Why visualization?*

People often say that a picture is like a thousand words. In the same
spirit, John Tukey, a major statistician at Princeton, wrote that "the
picture-examining eye is the best finder we have of the wholly
unanticipated."

[[../graphs/VIS-WhyVisualization.png]]

Visualization is further useful for initial data exploration, for
interpreting models, and for communicating results effectively.

Let us give some examples of different modes of visualization that
illustrate these points. The figure shows the miles per gallon of a
car as a function of the car's weight. The figure clearly illustrates
that as the weight of the car increases, the miles per gallon
decrease.

[[../graphs/VIS-InitialExploration.png]]

The same graph, but now colors of the points signify the number of
cylinders in the car: four for red, six for green, and eight in blue.

[[../graphs/VIS-ExploreFurther.png]]

On the same data, we now plot a regression line that captures the
intuition that as the weight of the car increases, the miles per
gallon decrease.

[[../graphs/VIS-RegressionLine.png]]

In this plot, we'll visualize burglaries in the city of Houston by
combining data and geographical location in a map.

[[../graphs/VIS-GeographicalData.png]]

This plot illustrates, using a heat map, the usage of rented bicycles
from the Hubway company. The horizontal axis is the hour of the day,
and the vertical axis the day of the week, starting on Sunday. The
heat map shows that the usage increases during the morning and night
rush hours on weekdays.

[[../graphs/VIS-ShowRelationships.png]]

The next plot helps us visualize histograms of different categories
using the Hubway data.

[[../graphs/VIS-ExploreCategories.png]]

This plot shows US unemployment by state. The lighter colors
corresponding to smaller unemployment, and the darker colors
corresponding to larger unemployment rates.

[[../graphs/VIS-MapAccording2Data.png]]

The plan this week is to create all of these visualizations. We'll see
how visualizations can be used to better understand data, communicate
information more effectively, show the results of analytical models.

[[../graphs/VIS-Power.png]]

** Quick Question (1 point possible)

Normally, a scatterplot only allows us to visualize two dimensions -
one on the x-axis, and one on the y-axis. In the previous video we
were able to show a third dimension on the scatterplot using what
attribute?

*** Answer

- [X] Color Color - correct
- [ ] Shape
- [ ] Location

*Explanation*

On slide 3, we show the scatterplot from slide 2, but with the number
of cylinders shown by the color of the points. This allows us to
visualize a third dimension of our data.

** Video 2: The World Health Organization (WHO)

The World Health Organization, WHO for short, is the authority for
health within the United Nations system.

[[../graphs/VIS-WHO.png]]

WHO communicates information about global health in order to inform
citizens, donors, policymakers, and organizations around the world.

[[../graphs/VIS-WorldHealthReport.png]]

Their primary publication is *World Health Report*. Each issue focuses
on a specific aspect of global health, and includes statistics and
experts' assessments.

WHO also maintains an open, online repository of global health
data. WHO provides some data visualizations, which helps them
communicate more effectively with the public. As an example, the graph
shows the World Energy Consumption during 2001 to 2003.

[[../graphs/VIS-OnlineDataRepository.png]]

** Quick Question (1 point possible)

Why is it particularly helpful for WHO to provide data visualizations?
Select all that apply.

*** Answer

- [ ] There is no other way to display information shown in
  visualizations like the Energy Consumption one.

- [X] When communicating information to the general public, a
  visualization like the Energy Consumption one is much easier to
  absorb than a table of numbers would be.

- [X] Visualizations can easily be used by policymakers and others who
  wish to present data from WHO.

*Explanation*

While there are other ways to display the data given in many
visualizations (like tables), visualizations help to better
communicate data to the public and can easily be used by others in
presentations.

** Video 3: What is Data Visualization?

We will discuss the meaning of data visualization, and why it's often
useful to visualize your data to discover hidden trends and
properties.

Data visualization is defined as a mapping of data properties to
visual properties.

Data properties are usually numerical or categorical, like the mean of
a variable, the maximum value of a variable, or the number of
observations with a certain property.

Visual properties can be $(x,y)$ coordinates to plot points on a
graph, colors to assign labels, sizes, shapes, heights, etc. Both
types of properties are used to better understand the data, but in
different ways.

[[../graphs/VIS-WhatsIsDataVisualization.png]]

To motivate the need for data visualization, let's look at a famous
example called Anscombe's Quartet. Each of these tables corresponds to
a different data set. We have four data sets, each with two variables,
$x$ and $y$.

Just looking at the tables of data, it's hard to notice anything
special about it. It turns out that the mean and variance of the $x$
variable is the same for all four data sets, the mean and variance of
the $y$ variable is the same for all four data sets, and the correlation
between $x$ and $y$, as well as the regression equation to predict $y$ from
$x$, is the exact same for all four data sets.

[[../graphs/VIS-AnscombeQ.png]]

So just by looking at data properties, we might conclude that these
data sets are very similar. But if we plot the four data sets, they're
very different.

These plots show the four data sets, with the x variable on the
x-axis, and the y variable on the y-axis. Visually, these data sets
look very different. But without visualizing them, we might not have
noticed this.

[[../graphs/VIS-AnscombeQ02.png]]

This is one example of why visualizing data can be very important.

We'll use the *ggplot2* package in R to create data visualizations. This
package was created by Hadley Wickham, who described ggplot as "a
plotting system for R based on the grammar of graphics, which tries to
take the good parts of base and lattice graphics and none of the bad
parts.

[[../graphs/VIS-ggplot.png]]

So what do we gain from using ggplot over just making plots using the
basic R functions, or what's referred to as base R?

Well, in base R, each mapping of data properties to visual properties
is its own special case. When we create a scatter plot, or a box plot,
or a histogram, we have to use a completely different function.

It's challenging to create any sophisticated visualizations. It's also
difficult to add elements to existing plots.

[[../graphs/VIS-BaseVSggplot.png]]

But in ggplot, the mapping of data properties to visual properties is
done by just adding layers to the plot. This makes it much easier to
create sophisticated plots and to add to existing plots.

So what is the grammar of graphics that ggplot is based on? All ggplot
graphics consist of three elements. The first is data, in a data
frame. The second is an aesthetic mapping, which describes how
variables in the data frame are mapped to graphical attributes.

This is where we'll define which variables are on the x- and y-axes,
whether or not points should be colored or shaped by certain
attributes, etc.

[[../graphs/VIS-GrammarOfGraphics.png]]

The third element is which geometric objects we want to determine how
the data values are rendered graphically. This is where we indicate if
the plot should have points, lines, bars, boxes, etc.

**  Quick Question (4/4 points)

In this quick question, we'll be asking you questions about the
following three plots, that we saw in Video 1. We'll refer to them as
the "Scatterplot", the "Histogram", and the "US Map".

The Scatterplot:

[[../graphs/Scatterplot_Week8.jpg.png]]

The Histogram:

[[../graphs/Histogram_Week8.jpg.png]]

The US Map:

[[../graphs/USmap_Week8.jpg.png]]

*** Question a

In the Scatterplot, what are the geometric objects?

- [ ] Bars
- [X] Points Points - correct
- [ ] Lines
- [ ] Polygons
- [ ] Boxes

*** Question

In the Histogram, what are the geometric objects?

**** Answer

- [X] Bars Bars - correct
- [ ] Points
- [ ] Lines
- [ ] Polygons
- [ ] Boxes

*** Question

In the US Map, what are the geometric objects?

**** Answer

- [ ] Bars
- [ ] Points
- [ ] Lines
- [X] Polygons Polygons - correct
- [ ] Boxes

*** Question

All three of these plots defined a particular aesthetic property. What
is it?

**** Answer

- [ ] The x-axis label.
- [ ] The y-axis label.
- [ ] Different shapes for different types of observations.
- [X] Colors. Colors. - correct
- [ ] A legend.

*Explanation*

The geometric objects for the Scatterplot are points, for the
Histogram are bars, and for the US Map are polygons (the states). All
three plots defined colors in the plot.

** Video 4: Basic Scatterplots Using ggplot

In the rest of this lecture, we'll be using the data file
[[https://courses.edx.org/asset-v1:MITx%2B15.071x_2a%2B2T2015%2Btype@asset%2Bblock/WHO.csv][WHO.csv]]. Please download this file to your computer, and save it to a
location that you will remember. This data comes from the
[[http://apps.who.int/gho/data/node.main][Global Health Observatory Data Repository]].

An R script file with all of the commands used in this lecture can be
downloaded [[https://courses.edx.org/asset-v1:MITx%2B15.071x_2a%2B2T2015%2Btype@asset%2Bblock/Unit7_WHO.R][here]].

Let's start by reading in our data. We'll be using the same data set
we used during week one, WHO.csv.

*** Download the data sets

In this part we can download the data

#+BEGIN_SRC R :session :results output :exports all
  library(parallel)

  if(!file.exists("../data")) {
          dir.create("../data")
  }

  fileUrl <- "https://courses.edx.org/asset-v1:MITx+15.071x_2a+2T2015+type@asset+block/WHO.csv"
  fileName <- "WHOu7.csv"
  dataPath <- "../data"

  filePath <- paste(dataPath, fileName, sep = "/")

  if(!file.exists(filePath)) {
          download.file(fileUrl, destfile = filePath, method = "curl")
  }

  list.files("../data")
#+END_SRC

#+RESULTS:
#+begin_example
 [1] "AirlinesCluster.csv"     "AnonymityPoll.csv"
 [3] "baseball.csv"            "BoeingStock.csv"
 [5] "boston.csv"              "ClaimsData.csv"
 [7] "ClaimsData.csv.zip"      "climate_change.csv"
 [9] "clinical_trial.csv"      "ClusterMeans.ods"
[11] "CocaColaStock.csv"       "CountryCodes.csv"
[13] "CPSData.csv"             "dailykos.csv"
[15] "eBayiPadTest.csv"        "eBayiPadTrain.csv"
[17] "emails.csv"              "energy_bids.csv"
[19] "flower.csv"              "FluTest.csv"
[21] "FluTrain.csv"            "framingham.csv"
[23] "gerber.csv"              "GEStock.csv"
[25] "healthy.csv"             "IBMStock.csv"
[27] "loans_imputed.csv"       "loans.csv"
[29] "MetroAreaCodes.csv"      "movieLens.txt"
[31] "mvtWeek1.csv"            "NBA_test.csv"
[33] "NBA_train.csv"           "parole.csv"
[35] "pisa2009test.csv"        "pisa2009train.csv"
[37] "PollingData_Imputed.csv" "PollingData.csv"
[39] "ProcterGambleStock.csv"  "quality.csv"
[41] "README.md"               "SampleSubmission.csv"
[43] "songs.csv"               "stevens.csv"
[45] "StocksCluster.csv"       "stopwords.txt"
[47] "tumor.csv"               "tweets.csv"
[49] "USDA.csv"                "WHO_Europe.csv"
[51] "WHO.csv"                 "WHOu7.csv"
[53] "wiki.csv"                "wine_test.csv"
[55] "wine.csv"
#+end_example

*** Load the data set

#+BEGIN_SRC R :session :results output :exports all
  writeLines("\n :: Loading data into their data frame.")
  WHO <- read.csv("../data/WHOu7.csv")
  str(WHO)
#+END_SRC

#+RESULTS:
#+begin_example

 :: Loading data into their data frame.
'data.frame':	194 obs. of  13 variables:
 $ Country                      : Factor w/ 194 levels "Afghanistan",..: 1 2 3 4 5 6 7 8 9 10 ...
 $ Region                       : Factor w/ 6 levels "Africa","Americas",..: 3 4 1 4 1 2 2 4 6 4 ...
 $ Population                   : int  29825 3162 38482 78 20821 89 41087 2969 23050 8464 ...
 $ Under15                      : num  47.4 21.3 27.4 15.2 47.6 ...
 $ Over60                       : num  3.82 14.93 7.17 22.86 3.84 ...
 $ FertilityRate                : num  5.4 1.75 2.83 NA 6.1 2.12 2.2 1.74 1.89 1.44 ...
 $ LifeExpectancy               : int  60 74 73 82 51 75 76 71 82 81 ...
 $ ChildMortality               : num  98.5 16.7 20 3.2 163.5 ...
 $ CellularSubscribers          : num  54.3 96.4 99 75.5 48.4 ...
 $ LiteracyRate                 : num  NA NA NA NA 70.1 99 97.8 99.6 NA NA ...
 $ GNI                          : num  1140 8820 8310 NA 5230 ...
 $ PrimarySchoolEnrollmentMale  : num  NA NA 98.2 78.4 93.1 91.1 NA NA 96.9 NA ...
 $ PrimarySchoolEnrollmentFemale: num  NA NA 96.4 79.4 78.2 84.5 NA NA 97.5 NA ...
#+end_example

We can see that we have 194 observations, or countries, and 13
different variables-- the name of the country, the region the
country's in, the population in thousands, the percentage of the
population under 15 or over 60, the fertility rate or average number
of children per woman, the life expectancy in years, the child
mortality rate, which is the number of children who die by age five
per 1,000 births, the number of cellular subscribers per 100
population, the literacy rate among adults older than 15, the gross
national income per capita, the percentage of male children enrolled
in primary school, and the percentage of female children enrolled in
primary school.

In week one, the very first plot we made in R was a scatterplot of
fertility rate versus gross national income. Let's make this plot
again, just like we did in week one.

#+BEGIN_SRC R :var basename="WHOw1Plot" :session :results none silent :exports none
  filename <- paste("../graphs/", basename, ".png", sep = "")

  png(filename = filename, bg = "white", width = 640, height = 480, units = "px")

  ## ----- Plot code begin here
  # Plot from Week 1
  plot(WHO$GNI, WHO$FertilityRate)
  ## ----- Plot code ends here

  ## Close the PNG device and plots
  dev.off()
#+END_SRC

#+CAPTION:  WHO plot from week 1
#+NAME:     fig:WHOw1Plot
#+ATTR_LaTeX: placement: [H]
[[../graphs/WHOw1Plot.png]]

This plot shows us that a higher fertility rate is correlated with a
lower income. Now, let's redo this scatter plot, but this time using
ggplot.

We'll see how ggplot can be used to make more visually
appealing and complex scatter plots.

#+begin_src R :session :results output :exports all
  writeLines("\n :: Install new package: ggplot2 ...")
  ## install.packages('ggplot2', repos='http://cran.rstudio.com/')
  writeLines("\n :: NOTE: Please comment after install once...")

  library(ggplot2)
  writeLines("\n :: Library ggplot2 loaded...")
#+end_src

#+RESULTS:
:
:  :: Install new package: ggplot2 ...
:
:  :: NOTE: Please comment after install once...
:
:  :: Library ggplot2 loaded...

Now, remember we need at least three things to create a plot using
ggplot-- data, an aesthetic mapping of variables in the data frame to
visual output, and a geometric object. So first, let's create the
ggplot object with the data and the aesthetic mapping.

We'll save it to the variable scatter plot, and then use the ggplot
function, where the first argument is the name of our data set, WHO,
which specifies the data to use, and the second argument is the
aesthetic mapping, ~aes~.

#+BEGIN_SRC R :var basename="WHOggplotExample" :session :results none silent :exports none
  filename <- paste("../graphs/", basename, ".png", sep = "")

  png(filename = filename, bg = "white", width = 640, height = 480, units = "px")

  ## ----- Plot code begin here
  # Create the ggplot object with the data and the aesthetic mapping:
  scatterplot <- ggplot(WHO, aes(x = GNI, y = FertilityRate))

  # Add the geom_point geometry
  scatterplot + geom_point()

  # Make a line graph instead:
  scatterplot + geom_line()

  # Switch back to our points:
  scatterplot + geom_point()

  # Redo the plot with blue triangles instead of circles:
  scatterplot + geom_point(color = "blue", size = 3, shape = 17)

  # Another option:
  scatterplot + geom_point(color = "darkred", size = 3, shape = 8)

  # Add a title to the plot:
  scatterplot + geom_point(colour = "blue", size = 3, shape = 17) +
          ggtitle("Fertility Rate vs. Gross National Income")

  # Save our plot:
  fertilityGNIplot <- scatterplot +
          geom_point(colour = "blue", size = 3, shape = 15) +
          ggtitle("Fertility Rate vs. Gross National Income")

  fertilityGNIplot
  ## ----- Plot code ends here

  ## Close the PNG device and plots
  dev.off()
#+END_SRC

#+CAPTION:  WHO scatter plot with ggplot
#+NAME:     fig:WHOggplotExample
#+ATTR_LaTeX: placement: [H]
[[../graphs/WHOggplotExample.png]]

Now, we need to tell ggplot what geometric objects to put in the
plot. We could use bars, lines, points, or something else. This is a
big difference between ggplot and regular plotting in R. You can build
different types of graphs by using the same ggplot object.

There's no need to learn one function for bar graphs, a completely
different function for line graphs, etc. So first, let's just create a
straightforward scatter plot. So the geometry we want to add is
points. We can do this by typing the name of our ggplot object,
scatter plot, and then adding the function, geom_point().

You should see a new plot in the Graphics window that looks similar to
our original plot, but there are already a few nice improvements. One
is that we don't have the data set name with a dollar  sign in front
of the label on each axis, just the variable name.

Another is that we have these nice grid lines in the background and
solid points that pop out from the background.

We could have made a line graph just as easily by changing point to
line.

In addition to specifying that the geometry we want is points, we can
add other options, like the color, shape, and size of the
points. Let's redo our plot with blue triangles instead of circles. In
the empty parentheses for ~geom_point~, we're going to specify some
properties of the points.

~scatterplot + geom_point(color = "blue", size = 3, shape = 17)~

Change ~blue~ to ~darkred~, and change shape to 8. Now, you should see
dark red stars. There are many different colors and shapes that you
can specify. We've provided some information in the text below this
video.

Now, let's save our plot to a file. We can do this by first saving our
plot to a variable.

~fertilityGNIplot = scatterplot +~
~geom_point(colour = "blue", size = 3, shape = 17) +
~ggtitle("Fertility Rate vs. Gross National Income")~

This will save our scatter plot to the variable,
~fertilityGNIplot~. Now, let's create a file we want to save our plot
to. We can do that with the ~pdf~ function.

~pdf("MyPlot.pdf")~

~print(fertilityGNIplot)~

~dev.off()~

*** Colors and shapes in R

If you want to see all of the available colors in R, type in your R
console:

~colors()~

All of the available shapes are described in the following image:

[[../graphs/Shapes.jpg.png]]

The number 0 corresponds to an empty square, the number 6 corresponds
to an upside down triangle, etc.

Source: This image comes from [[http://www.cookbook-r.com/Graphs/Shapes_and_line_types/][Cookbook for R]].

** Quick Question (1 point possible)

*** Question

In R, change the shape of your points to the number 15. What shape are
the points now?

**** Answer

- [ ] Circles
- [ ] Diamonds
- [ ] Crosses
- [X] Squares
- [ ] Stars

*Explanation*

If you type:

~scatterplot + geom_point(shape = 15)~

where scatterplot is the plot we created in the previous video, you
can see that the points are squares.

** Video 5: Advanced Scatter plots Using ggplot

Now, let's color the points by region instead. This time, we want to
add a color option to our aesthetic, since we're assigning a variable
in our data set to the colors.

#+BEGIN_SRC R :var basename="WHObyRegion" :session :results none silent :exports none
  filename <- paste("../graphs/", basename, ".png", sep = "")

  png(filename = filename, bg = "white", width = 640, height = 480, units = "px")

  ## ----- Plot code begin here
  # Color the points by region:
  ggplot(WHO, aes(x = GNI, y = FertilityRate, color = Region)) + geom_point()
  ## ----- Plot code ends here

  ## Close the PNG device and plots
  dev.off()
#+END_SRC

#+CAPTION:  Scatter plot of WHO by region
#+NAME:     fig:WHObyRegion
#+ATTR_LaTeX: placement: [H]
[[../graphs/WHObyRegion.png]]

Now, in our plot, we should see that each point is colored
corresponding to the region that country belongs in. So the countries
in Africa are colored red, the countries in the Americas are colored
gold, the countries in the Eastern Mediterranean are colored green,
etc.

This really helps us see something that we didn't see before. The
points from the different regions are really located in different
areas on the plot. Let's now instead color the points according to the
country's life expectancy.

#+BEGIN_SRC R :var basename="WHOscatterPlotLifeExpectancy" :session :results none silent :exports none
  filename <- paste("../graphs/", basename, ".png", sep = "")

  png(filename = filename, bg = "white", width = 640, height = 480, units = "px")

  ## ----- Plot code begin here
  # Color the points according to life expectancy:
  ggplot(WHO, aes(x = GNI, y = FertilityRate, color = LifeExpectancy)) +
          geom_point()
  ## ----- Plot code ends here

  ## Close the PNG device and plots
  dev.off()
#+END_SRC

#+CAPTION:  Who scatter plot by life expectancy
#+NAME:     fig:WHOscatterPlotLifeExpectancy
#+ATTR_LaTeX: placement: [H]
[[../graphs/WHOscatterPlotLifeExpectancy.png]]

Now, we should see that each point is colored according to the life
expectancy in that country. Notice that before, we were coloring by a
factor variable, Region.

So we had exactly seven different colors corresponding to the seven
different regions. Here, we're coloring by LifeExpectancy instead,
which is a numerical variable, so we get a gradient of colors, like
this.

Lighter blue corresponds to a higher life expectancy, and darker blue
corresponds to a lower life expectancy.

Suppose we were interested in seeing whether the fertility rate of a
country was a good predictor of the percentage of the population
under 15. Intuitively, we would expect these variables to be highly
correlated. But before trying any statistical models, let's explore
our data with a plot.

#+BEGIN_SRC R :var basename="WHOFertilityRateVSPopUnder15" :session :results none silent :exports none
  filename <- paste("../graphs/", basename, ".png", sep = "")

  png(filename = filename, bg = "white", width = 640, height = 480, units = "px")

  ## ----- Plot code begin here

  # Is the fertility rate of a country was a good predictor of the
  # percentage of the population under 15?
  ggplot(WHO, aes(x = FertilityRate, y = Under15)) + geom_point()

  ## ----- Plot code ends here

  ## Close the PNG device and plots
  dev.off()
#+END_SRC

#+CAPTION:  WHO fertility rate vs. population under 15
#+NAME:     fig:WHOFertilityRateVSPopUnder15
#+ATTR_LaTeX: placement: [H]
[[../graphs/WHOFertilityRateVSPopUnder15.png]]

This is really interesting. It looks like the variables are certainly
correlated, but as the fertility rate increases, the variable,
~Under15~ starts increasing less.

So this doesn't really look like a linear relationship. But we suspect
that a log transformation of ~FertilityRate~ will be better. Let's
give it a shot.

#+BEGIN_SRC R :var basename="WHOlogFertilityRateVSUnder15" :session :results none silent :exports none
  filename <- paste("../graphs/", basename, ".png", sep = "")

  png(filename = filename, bg = "white", width = 640, height = 480, units = "px")

  ## ----- Plot code begin here
  # Let's try a log transformation:
  ggplot(WHO, aes(x = log(FertilityRate), y = Under15)) + geom_point()
  ## ----- Plot code ends here

  ## Close the PNG device and plots
  dev.off()
#+END_SRC

#+CAPTION:  WHO scatter plot of the logarithm of fertility rate vs under 15
#+NAME:     fig:WHOlogFertilityRateVSUnder15
#+ATTR_LaTeX: placement: [H]
[[../graphs/WHOlogFertilityRateVSUnder15.png]]

Let's try building in a simple linear regression model to predict the
percentage of the population under 15, using the log of the fertility
rate.

#+begin_src R :session :results output :exports all
  writeLines("\n :: Simple linear regression model to predict the percentage\n of the population under 15, using the log of the fertility rate:")
  mod <- lm(Under15 ~ log(FertilityRate), data = WHO)
  summary(mod)
#+end_src

#+RESULTS:
#+begin_example

 :: Simple linear regression model to predict the percentage
 of the population under 15, using the log of the fertility rate:

Call:
lm(formula = Under15 ~ log(FertilityRate), data = WHO)

Residuals:
     Min       1Q   Median       3Q      Max
-10.3131  -1.7742   0.0446   1.7440   7.7174

Coefficients:
                   Estimate Std. Error t value Pr(>|t|)
(Intercept)          7.6540     0.4478   17.09   <2e-16 ***
log(FertilityRate)  22.0547     0.4175   52.82   <2e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 2.65 on 181 degrees of freedom
  (11 observations deleted due to missingness)
Multiple R-squared:  0.9391,	Adjusted R-squared:  0.9387
F-statistic:  2790 on 1 and 181 DF,  p-value: < 2.2e-16
#+end_example

Let's look at the summary of our model. It looks like the log of
~FertilityRate~ is indeed a great predictor of ~Under15~. The variable
is highly significant, and our ~R-squared~ is $0.9391$.

Visualization was a great way for us to realize that the log
transformation would be better. If we instead had just used the
~FertilityRate~, the R-squared would have been $0.87$. That's a pretty
significant decrease in ~R-squared~.

So now, let's add this regression line to our plot. This is pretty
easy in ggplot. We just have to add another layer.

#+BEGIN_SRC R :var basename="WHOfetilityRvsUnder15LRmodel" :session :results none silent :exports none
  filename <- paste("../graphs/", basename, ".png", sep = "")

  png(filename = filename, bg = "white", width = 640, height = 480, units = "px")

  ## ----- Plot code begin here
  # Add this regression line to our plot:
  ggplot(WHO, aes(x = log(FertilityRate), y = Under15)) + geom_point() +
          stat_smooth(method = "lm")
  ## ----- Plot code ends here

  ## Close the PNG device and plots
  dev.off()
#+END_SRC

#+CAPTION:  WHO scatter plot of the fertility rate vs. under 15 with a linear regression model
#+NAME:     fig:WHOfetilityRvsUnder15LRmodel
#+ATTR_LaTeX: placement: [H]
[[../graphs/WHOfetilityRvsUnder15LRmodel.png]]

Now, you should see a blue line going through the data. This is our
regression line. By default, ggplot will draw a $95\%$ confidence
interval shaded around the line.

We can change this by specifying options within the statistics layer.

This will give a $99\%$ confidence interval.

#+BEGIN_SRC R :var basename="WHOFertilityRatevsUnder15LM99" :session :results none silent :exports none
  filename <- paste("../graphs/", basename, ".png", sep = "")

  png(filename = filename, bg = "white", width = 640, height = 480, units = "px")

  ## ----- Plot code begin here
  # 99% confidence interval
  ggplot(WHO, aes(x = log(FertilityRate), y = Under15)) + geom_point() +
          stat_smooth(method = "lm", level = 0.99)
  ## ----- Plot code ends here

  ## Close the PNG device and plots
  dev.off()
#+END_SRC

#+CAPTION:  WHO scatter plot of fertility rate vs under 15 with regression model with 99%
#+NAME:     fig:WHOFertilityRatevsUnder15LM99
#+ATTR_LaTeX: placement: [H]
[[../graphs/WHOFertilityRatevsUnder15LM99.png]]

We could instead take away the confidence interval altogether by
deleting

~level = 0.99~

and typing

~se = FALSE~

Now, we just have the regression line in blue.

#+BEGIN_SRC R :var basename="WHOFertilityRVsUnder15WlmOnly" :session :results none silent :exports none
  filename <- paste("../graphs/", basename, ".png", sep = "")

  png(filename = filename, bg = "white", width = 640, height = 480, units = "px")

  ## ----- Plot code begin here
  # No confidence interval in the plot
  ggplot(WHO, aes(x = log(FertilityRate), y = Under15)) + geom_point() +
          stat_smooth(method = "lm", se = FALSE)
  ## ----- Plot code ends here

  ## Close the PNG device and plots
  dev.off()
#+END_SRC

#+CAPTION:  WHO Fertility rate vs. Under 15 with LM only
#+NAME:     fig:WHOFertilityRVsUnder15WlmOnly
#+ATTR_LaTeX: placement: [H]
[[../graphs/WHOFertilityRVsUnder15WlmOnly.png]]

We could also change the color of the regression line
by typing as an option

~color = "orange"~

#+BEGIN_SRC R :var basename="WHOFerRateVsUnder15WlmOrange" :session :results none silent :exports none
  filename <- paste("../graphs/", basename, ".png", sep = "")

  png(filename = filename, bg = "white", width = 640, height = 480, units = "px")

  ## ----- Plot code begin here
  # Change the color of the regression line:
  ggplot(WHO, aes(x = log(FertilityRate), y = Under15)) + geom_point() +
          stat_smooth(method = "lm", colour = "orange")
  ## ----- Plot code ends here

  ## Close the PNG device and plots
  dev.off()
#+END_SRC

#+CAPTION:  WHO Fertility rate vs Under 15 with regression model in orange
#+NAME:     fig:WHOFerRateVsUnder15WlmOrange
#+ATTR_LaTeX: placement: [H]
[[../graphs/WHOFerRateVsUnder15WlmOrange.png]]

Now, we have an orange linear regression line. As we've seen in this
lecture, scatter plots are great for exploring data. However, there
are many other ways to represent data visually, such as box plots,
line charts, histograms, heat maps, and geographic maps.

In some cases, it may be better to choose one of these other ways of
visualizing your data.

Luckily, ggplot makes it easy to go from one type of visualization to
another, simply by adding the appropriate layer to the plot.

*So what is the edge of visualizations?*

The WHO data that we used here is used by citizens, policymakers, and
organizations around the world.

[[../graphs/VIS-TAE.png]]

Visualizing the data facilitates the understanding of global health
trends at a glance.

By using ggplot in R, we're able to visualize data for exploration,
modeling, and sharing analytics results.

** Quick Question (1 point possible)

Create the fertility rate versus population under 15 plot again:

~ggplot(WHO, aes(x = FertilityRate, y = Under15)) + geom_point()~

Now, color the points by the Region variable.

Note: You can add ~scale_color_brewer(palette="Dark2")~ to your plot
if you are having a hard time distinguishing the colors (this color
palette is often better if you are colorblind). To use this option,
you should just add ~scale_color_brewer(palette="Dark2")~ to your
plotting command right after ~geom_point()~. To find out more about
using ggplot in a colorblind-friendly way, please see this website.

#+BEGIN_SRC R :var basename="WHOFertRvsUnder15NewPalette" :session :results none silent :exports none
  filename <- paste("../graphs/", basename, ".png", sep = "")

  png(filename = filename, bg = "white", width = 640, height = 480, units = "px")

  ## ----- Plot code begin here
  ggplot(WHO, aes(x = FertilityRate, y = Under15, color = Region)) +
          geom_point() + scale_color_brewer(palette="Dark2")
  ## ----- Plot code ends here

  ## Close the PNG device and plots
  dev.off()
#+END_SRC

#+CAPTION:  Using a new palette to improve the readability of the plot
#+NAME:     fig:WHOFertRvsUnder15NewPalette
#+ATTR_LaTeX: placement: [H]
[[../graphs/WHOFertRvsUnder15NewPalette.png]]

One region in particular has a lot of countries with a very low
fertility rate and a very low percentage of the population
under 15. Which region is it?

- [ ] Africa
- [ ] Americas
- [ ] Eastern Mediterranean
- [X] Europe
- [ ] South-East Asia
- [ ] Western Pacific

*Explanation*

You can color the points by region if you adjust the command to the
following:

~ggplot(WHO, aes(x = FertilityRate, y = Under15, color=Region)) + geom_point()~

Most of the countries in Europe have a very low fertility rate and a
very low percentage of the population under 15.
